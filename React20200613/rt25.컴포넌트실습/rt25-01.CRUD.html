<!-- ex08_crud.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>

    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <!-- CSS import -->
    <link rel="stylesheet" href="../css/reset.css" />
    <style>
      .strong {
        color: red;
        font-weight: bold;
        font-size: 1.2em;
      }
      label {
        display: inline-block;
        width: 80px;
      }
      #app > div {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <pre>
        CRUD 방법을 학습한다.

        Object Array 에서 최대값 구하는 방법은 구글 검색을 이용한다.
        ==> 검색조건: javascript object array max
        방법1. .map() 를 사용하는 방법
        방법2. .reducer()
    </pre>
    <div id="app">
      <div>
        <h1>Creat Read Update Delete</h1>
        <div><label for="">Name : </label> <input type="text" /></div>
        <div><label for="">Power : </label> <input type="text" /></div>
        <button>Add</button>
        <hr />
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>NAME</th>
            <th>POWER</th>
            <th>CRUD</th>
          </tr>
        </thead>
        <tbody>
          <tr class="">
            <td>1</td>
            <td>슈퍼맨</td>
            <td>100</td>
            <td>
              <button>Del</button>
              <button>Power Up</button>
              <button>Power Down</button>
              <button>Edit</button>
            </td>
          </tr>
          <tr class="strong">
            <td>2</td>
            <td>아쿠아맨</td>
            <td>300</td>
            <td>
              <button>Del</button>
              <button>Power Up</button>
              <button>Power Down</button>
              <button>Edit</button>
            </td>
          </tr>
          <tr class="strong">
            <td>3</td>
            <td>스파이더맨</td>
            <td>500</td>
            <td>
              <button>Del</button>
              <button>Power Up</button>
              <button>Power Down</button>
              <button>Edit</button>
            </td>
          </tr>
          <tr class="">
            <td>4</td>
            <td>배트맨</td>
            <td>30</td>
            <td>
              <button>Del</button>
              <button>Power Up</button>
              <button>Power Down</button>
              <button>Edit</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </body>
</html>

<!-- react 플러그인 include   -->
<!-- 주의: 사이트를 배포할 때는 "development.js"를 "production.min.js"로 대체하세요. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.12.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.11.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>

<script type="text/babel">
  console.log(React);
  console.log(ReactDOM);

  class CrudApp extends React.Component {
    state = {
      user: {
        id: 0,
        name: "",
        power: 0,
      },
      list: [
        { id: 1, name: "슈퍼맨", power: 100 },
        { id: 2, name: "아쿠아맨", power: 300 },
        { id: 3, name: "스파이더맨", power: 500 },
        { id: 4, name: "배트맨", power: 30 },
      ],
    };
    constructor(props) {
      super(props);

      //this bind처리
      this.insert = this.insert.bind(this);
      this.doDel = this.doDel.bind(this);
      this.doUp = this.doUp.bind(this);
      this.doDown = this.doDown.bind(this);
      this.doEdit = this.doEdit.bind(this);
    }
    insert(user) {
      //input에 입력한 값들을 list에 추가하기
      console.log(user);

      const max = this.state.list.reduce((a, b) => {
        return a.id > b.id ? a.id : b.id;
      });
      const newMan = {
        id: max + 1,
        name: user.name,
        power: user.power,
      };
      // newMan과 this.state.list를 합치기
      let listCopy = { ...this.state.list, newMan };

      this.setState({
        list: listCopy,
      });
    }
    doDel(id) {
      //배열에서 삭제=> splice(index, count)
      let listCopy = this.state.list.filter((man) => {
        return man.id !== id;
      });
      this.setState({
        list: listCopy,
      });
    }
    doUp(id) {
      //100씩 증가
      let listCopy = this.state.list.map((man) => {
        if (man.id === id) {
          man.power = Number(man.power) + 100;
        }
        return man;
      });
      this.setState({
        list: listCopy,
      });
    }
    doDown(id) {
      //50씩 감소
      let listCopy = this.state.list.map((man) => {
        if (man.id === id) {
          man.power = Number(man.power) - 50;
        }
        return man;
      });
      this.setState({
        list: listCopy,
      });
    }
    doEdit(user) {
      //선택한 사람 정보를 input에 보여주기
      let listCopy = this.state.list.map(function (man) {
        if (man.id === this.id) {
          return this;
        } else {
          return man;
        }
      }, user);
      this.setState({
        list: listCopy,
      });
    }
    render() {
      return (
        <div>
          <CrudInput insert={this.insert} />
          <hr />
          <CrudList
            list={this.state.list}
            doDel={this.doDel}
            doUp={this.doUp}
            doDown={this.doDown}
            doEdit={this.Edit}
          />
        </div>
      ); //state를 다 넘기고 싶을땐 {...this.state.list}
      //state를 하나만 넘기고 싶을땐 {this.state.list}
    }
  }

  class CrudInput extends React.Component {
    state = {
      name: "",
      power: 0,
      //input을 처리하기 위한 state는 input의 갯수만큼 만든다
    };
    constructor(props) {
      super(props);
      //this bind 처리
      this.insert = this.insert.bind(this);

      //ref 생성
      this.refUserName = React.createRef();
      this.refUserPower = React.createRef();
    }
    insert(e) {
      //validate 올린 코드 참조
      //newMan 생성
      let newMan = {
        name: this.refUserName.current.value,
        power: Number(this.refUserPower.current.value),
      };
      //부모 CrudApp.insert 함수를 호출
      this.props.insert(newMan);
    }
    render() {
      const { name, power } = this.state;
      return (
        <div>
          <h1>Creat Read Update Delete</h1>
          <div>
            <label htmlFor="">Name : </label>
            <input
              type="text"
              name="name"
              ref={this.refUserName}
              defaultValue={name}
            />
          </div>
          <div>
            <label htmlFor="">Power : </label>
            <input
              type="text"
              name="name"
              ref={this.refUserPower}
              defaultValue={power}
            />
          </div>
          <button onClick={this.insert}>Add</button>
        </div>
      );
    }
  }

  class CrudList extends React.Component {
    render() {
      /*
        const items = elements.map(function (value, key) => {
        return <li key={key}>{value}</li>;
      })
     */
      const rows = this.props.list;
      const trs = rows.map((man, index) => {
        return (
          <CrudListItem
            key={index}
            man={man}
            doDel={this.props.doDel}
            doUp={this.props.doUp}
            doDown={this.props.doDown}
            doEdit={this.props.Edit}
          />
        );
      });
      return (
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>NAME</th>
              <th>POWER</th>
              <th>CRUD</th>
            </tr>
          </thead>
          <tbody>{trs}</tbody>
        </table>
      );
    }
  }

  class CrudListItem extends React.Component {
    state = {
      isEditMode: false,
    };
    constructor(props) {
      super(props);
      //this bind 처리
      this.doDel = this.doDel.bind(this);
      this.doUp = this.doUp.bind(this);
      this.doDown = this.doDown.bind(this);
      this.doEdit = this.doEdit.bind(this);
      this.doSave = this.doSave.bind(this);

      //ref 생성
      this.refEditName = React.createRef();
      this.refEditPower = React.createRef();
    }
    doDel(e) {
      const { id } = this.props.man;
      //CrudApp.doDel 함수 호출
      this.props.doDel(id);
    }
    doUp(e) {
      const { id } = this.props.man;
      //CrudApp.doUp 함수 호출
      this.props.doUp(id);
    }
    doDown(e) {
      const { id } = this.props.man;
      //CrudApp.doDown 함수 호출
      this.props.doDown(id);
    }
    doEdit(e) {
      this.setState((prevState, props) => {
        return {
          isEditMode: !prevState.isEditMode,
        };
      });
    }
    doSave(e) {
      this.setState((prevState, props) => {
        return {
          isEditMode: !prevState.isEditMode,
        };
      });
      //변경값 생성
      const { id } = this.props.man;
      const newMan = {
        id: id,
        name: this.refEditName.current.value,
        power: Number(this.refEditPower.current.value),
      };
      //CrudApp.doEdit() 함수 호출
      this.props.doEdit(newMan);
    }

    render() {
      const { id, name, power } = this.props.man;
      const formView = (
        <tr key={id}>
          <td>{id}</td>
          <td>{name}</td>
          <td>{power}</td>
          <td>
            <button onClick={this.doDel}>Del</button>
            <button onClick={this.doUp}>Power Up</button>
            <button onClick={this.doDown}>Power Down</button>
            <button onClick={this.doEdit}>Edit</button>
          </td>
        </tr>
      );
      const formEdit = (
        <tr key={id}>
          <td>{id}</td>
          <td>
            <input
              type="text"
              name="name"
              ref={this.refEditName}
              defaultValue={name}
            />
          </td>
          <td>
            <input
              type="text"
              name="name"
              ref={this.refEditPower}
              defaultValue={power}
            />
          </td>
          <td>
            <button onClick={this.doDel}>Del</button>
            <button onClick={this.doUp}>Power Up</button>
            <button onClick={this.doDown}>Power Down</button>
            <button onClick={this.doSave}>save</button>
          </td>
        </tr>
      );
      return this.state.isEditMode === true ? formEdit : formView;
      return (
        //배열문 처리 컴포넌트들은 key값을 넣어줘야 한다 속도를 빠르게 하기 위해서
        <tr key={id}>
          <td>{id}</td>
          <td>{name}</td>
          <td>{power}</td>
          <td>
            <button onClick={this.doDel}>Del</button>
            <button onClick={this.doUp}>Power Up</button>
            <button onClick={this.doDown}>Power Down</button>
            <button onClick={this.doEdit}>Edit</button>
          </td>
        </tr>
      );
    }
  }

  ReactDOM.render(<CrudApp />, document.getElementById("app"));
</script>
